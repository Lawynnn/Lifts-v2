<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    {{!-- Stylesheet --}}
    <link rel="stylesheet" href="/stylesheets/style.css">
    
    {{!-- AOS --}}
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    {{!-- Fontawesome --}}
    <script src="https://kit.fontawesome.com/d978b3dc24.js" crossorigin="anonymous"></script>

    {{!-- jQuery --}}
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    {{!-- Bootstrap --}}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2" crossorigin="anonymous"></script>

    <title>Manage ({{bot.data.username}}) &#9679; Doppy</title>
</head>
<body class="root">
    <nav class="nav-root">
        <div class="nav-content">
            <div class="nav-header">
                <a href="/">
                    <h2>Doppy<span>Beta</span></h2>
                </a>    
            </div>
            <div class="nav-links">
                <a href="/"><i class="fa-solid fa-house"></i></a>
                <a href="/about"><i class="fa-solid fa-people-group"></i></a>
                <a href="/wiki"><i class="fa-solid fa-circle-question"></i></a>
                <span class="separator"></span>
                <div class="auth">
                    {{#if user}}
                        <a href="/logout" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Logout"><i class="fa-solid fa-arrow-right-from-bracket"></i> <span></span></a>
                        <a href="/settings" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Settings"><i class="fa-solid fa-gear"></i></a>
                        <a href="/dashboard" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Dashboard">
                            <img class="avatar" src="https://cdn.discordapp.com/avatars/{{user._json.id}}/{{user._json.avatar}}.png">
                        </a>
                    {{else}}
                        <a href="/auth/discord" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Login"><i class="fa-brands fa-discord"></i> Login</a>
                    {{/if}}
                </div>
            </div>
        </div>
    </nav>
    
    <div class="manage-root">
        <div class="manage-content">
            <div class="manage-header">
                <h2>{{bot.data.username}}</h2>
                <div class="manage-tabs">
                    <button onclick="updateTab(0); window.location = '#'" href="#">Dashboard</button>
                    <button onclick="updateTab(1); window.location = '#commands'" href="#commands">Commands</button>
                    <button onclick="updateTab(2); window.location = '#variables'" href="#variables">Variables</button>
                    <button onclick="updateTab(3); window.location = '#status'" href="#status">Status</button>
                </div>
            </div>
            <div class="manage-body">

                <div class="body-dashboard" id="tab">
                    <div class="category">
                        <div class="title">
                            <h2>Informations<span>{{bot.data.username}}</span></h2>
                        </div>
                        <div class="content">
                            <h3>Hosting time <span id="hostTime">{{time}}</span></h3>
                            <h3>Status <span id="status">
                                <span id="loader-info" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Loading...
                            </span></h3>
                            <h3>Servers <span id="servers">
                                <span id="loader-info" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Loading...
                            </span></h3>
                            <h3>Users <span id="users">
                                <span id="loader-info" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Loading...
                            </span></h3>
                            <h3>Channels <span id="channels">
                                <span id="loader-info" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Loading...
                            </span></h3>
                            <h3>Commands <span id="commands">
                                <span id="loader-info" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Loading...
                            </span></h3>
                            <h3>Variables <span id="variables">
                                <span id="loader-info" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Loading...
                            </span></h3>
                            <h3>Creation date <span id="createdAt">
                                <span id="loader-info" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                Loading...
                            </span></h3>
                        </div>
                    </div>
                    <div class="category" data-aos="fade-in">
                        <div class="title">
                            <h2>Manage<span>Hosting</span></h2>
                        </div>
                        <div class="content">
                            <form onsubmit="FormValidationHost(event)" action="/api/v1/db/host/{{bot._id}}" method="post">
                                <button type="submit">
                                    <span id="HostLoader" style="display: none;" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    Add 30 minutes of hosting
                                </button>
                            </form>
                            <form onsubmit="FormValidationStopHost(event)" action="/api/v1/db/stop/host/{{bot._id}}" method="post">
                                <button type="submit" class="error">
                                    <span id="StopHostLoader" style="display: none;" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                    Stop bot hosting  <i style="color: orange;" class="fa-solid fa-triangle-exclamation"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="category" data-aos="fade-in">
                        <div class="title">
                            <h2>Manage<span>{{bot.data.username}}</span></h2>
                        </div>
                        <div class="content">
                            <form onsubmit="FormValidationReload(event)" action="/api/v1/bot/reload/{{bot._id}}" method="post">
                                <button type="submit">
                                    {{!-- <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> --}}
                                    Force reload bot commands
                                </button>
                            </form>
                            <form class="input-button">
                                <input type="number" placeholder="Permissions" id="permissionPower" value="8">
                                <button type="button" onclick="inviteBot(event)">
                                    Invite bot in your server
                                </button>
                            </form>
                            <form onsubmit="FormValidationCleanup(event)" action="/api/v1/bot/cleanup/{{bot._id}}" method="post">
                                <button class="error" type="submit">
                                    {{!-- <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> --}}
                                    Cleanup bot commands <i style="color: orange;" class="fa-solid fa-triangle-exclamation"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="manage-commands body-dashboard" id="tab">
                    <div class="category">
                        <div class="title">
                            <h2>Commands<span>{{bot.data.username}}</span></h2>
                            <div class="btns">
                                <button onClick="window.location = '/create/command/{{bot._id}}'" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Create"><i class="fa-solid fa-square-plus"></i><span id="new"></span></button>
                                <button data-bs-toggle="tooltip" data-bs-placement="bottom" title="Refresh"><i class="fa-solid fa-arrows-rotate"></i><span id="ref"></span></button>
                            </div>
                            
                        </div>
                        <div class="content">
                            {{#each bot.commands}}
                                <div class="command-card">
                                    <div class="header"
                                        style="border-left: 2px solid {{#if this.disabled}}red{{else}}rgb(0, 255, 0){{/if}};"
                                    >
                                        <h3>{{this.name}}</h3>
                                        <span>{{this.trigger}}</span>
                                    </div>
                                    <div class="actions">
                                        <button onClick="deleteCommand(event, '{{this._id}}')" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Delete"><i class="fa-solid fa-trash"></i></button>
                                        {{#if this.disabled}}
                                            <button onClick="enableCommand(event, '{{this._id}}')" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Enable"><i class="fa-solid fa-power-off"></i></button>
                                        {{else}}
                                            <button onClick="disableCommand(event, '{{this._id}}')" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Disable"><i class="fa-solid fa-power-off"></i></button> 
                                        {{/if}}
                                        <button onClick="window.location = '/manage/{{../bot._id}}/command/{{this._id}}'" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button>
                                    </div>
                                </div>
                            {{/each}}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

<script type="text/javascript">
    AOS.init();
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

    function inviteBot(e) {
        window.location = 'https://discord.com/api/oauth2/authorize?client_id={{bot.data.id}}&permissions=' + $('#permissionPower').val() + '&scope=bot'
    }

    function updateTab(tab) {
        $('.manage-tabs').children().each(function(i, el) {
            if(i == tab) {
                $(el).addClass('active');
            } else {
                $(el).removeClass('active');
            } 
        });

        $('*[id*=tab]').each(function(i, el) {
            console.log(i);
            if(i == tab) {
                $(el).show();
            } else {
                $(el).css('display', 'none');
            } 
        })
    }

    const tabName = window.location.hash.substr(1);
    let tab = 0;
    switch (tabName) {
        case "commands":
            tab = 1;
            break
        case "variables":
            tab = 2;
            break
        case "status":
            tab = 3;
            break
    }
    $('.manage-tabs').children().eq(tab).addClass('active');
    $('*[id*=tab]').each(function(i, el) {
        if(i == tab) {
            $(el).show();
        } else {
            $(el).hide();
        } 
    })

    document.addEventListener('DOMContentLoaded', async (event) => {
        await new Promise(r => setTimeout(r, 1));

        $.post("/api/v1/bot/status/{{bot._id}}").done(function(data) {
            $('#loader-info').remove();
            $('#status').html(data.online ? "Online" : "Offline");
            $('#status').css("color", data.online ? "#00ff00" : "#ff7373");
            $('#servers').html(data.guilds || 0);
            $('#users').html(data.users || 0);
            $('#channels').html(data.channels || 0);
            $('#commands').html(data.commands || 0);
            $('#variables').html(data.variables || 0);
            $('#createdAt').html(new Date(data.createdAt).toDateString() || "Unknown");
        });
    });

    function FormValidationHost(e) {
        e.preventDefault();
        $('#HostLoader').show();
        $('#HostLoader').parent().prop('disabled', true);
        $.post("/api/v1/db/host/{{bot._id}}").done(function(data) {
            if(data.hostTime) {
                $('#HostLoader').hide()
                window.location.reload();
            } else {
                $('#HostLoader').hide()
                $('#HostLoader').parent().prop('disabled', false);
                alert(data.message);
            }
        });
    }

    function FormValidationStopHost(e) {
        e.preventDefault();
        $('#StopHostLoader').show();
        $('#StopHostLoader').parent().prop('disabled', true);
        $.post("/api/v1/db/stop/host/{{bot._id}}").done(function(data) {
            if(data.success) {
                $('#StopHostLoader').hide()
                window.location.reload();
            } else {
                $('#StopHostLoader').hide()
                $('#StopHostLoader').parent().prop('disabled', false);
                alert(data.error);
            }
        })
    }

</script>