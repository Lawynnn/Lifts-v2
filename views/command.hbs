<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    {{!-- Stylesheet --}}
    <link rel="stylesheet" href="/stylesheets/style.css">

    {{!-- Fontawesome --}}
    <script src="https://kit.fontawesome.com/d978b3dc24.js" crossorigin="anonymous"></script>

    {{!-- jQuery --}}
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

    {{!-- Bootstrap --}}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
        crossorigin="anonymous"></script>

    <title>Command ({{command.name}}) &#9679; Doppy</title>
</head>

<body class="root" style="background: var(--col-bg)">
    <nav class="nav-root">
        <div class="nav-content">
            <div class="nav-header">
                <a href="/">
                    <h2>Doppy<span>Beta</span></h2>
                </a>
            </div>
            <div class="nav-links">
                <a href="/"><i class="fa-solid fa-house"></i></a>
                <a href="/about"><i class="fa-solid fa-people-group"></i></a>
                <a href="/wiki"><i class="fa-solid fa-circle-question"></i></a>
                <span class="separator"></span>
                <div class="auth">
                    {{#if user}}
                    <a href="/logout" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Logout"><i
                            class="fa-solid fa-arrow-right-from-bracket"></i> <span></span></a>
                    <a href="/settings" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Settings"><i
                            class="fa-solid fa-gear"></i></a>
                    <a href="/dashboard" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Dashboard">
                        <img class="avatar"
                            src="https://cdn.discordapp.com/avatars/{{user._json.id}}/{{user._json.avatar}}.png">
                    </a>
                    {{else}}
                    <a href="/auth/discord" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Login"><i
                            class="fa-brands fa-discord"></i> Login</a>
                    {{/if}}
                </div>
            </div>
        </div>
    </nav>

    <div id="error" class="toast align-items-center position-fixed bottom-0 end-0 m-3" style="
        --bs-toast-border-color: #ff0000;
        --bs-toast-border-width: 2px;
        --bs-toast-bg: rgb(255 0 0 / 18%);
        --bs-toast-color: #fff;
    " role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
                aria-label="Close"></button>
        </div>
    </div>
    <div class="command-root">
        <div class="command-container">
            <div class="header">
                {{!-- <a href="/manage/{{bot._id}}"><i class="fa-solid fa-arrow-left"></i> Back to manage</a> --}}
            </div>
            <form onsubmit="cmdCall(event)" method="post"
                action="/api/v1/db/update/command/{{command._id}}/{{bot._id}}">
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span style="
                            border-radius: 5px 0px 0px 5px;
                            border: 1px solid rgb(19, 47, 76);
                            background-color: #06101a;
                            color: white;
                        " class="input-group-text" id="basic-addon1">Name</span>
                    </div>
                    <input style="
                        border: 1px solid rgb(19, 47, 76);
                        background-color: rgb(5, 29, 54);
                        color: white;
                    " value="{{command.name}}" name="_name" id="_nanme" type="text" class="form-control"
                        placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">
                </div>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <span style="
                            border-radius: 5px 0px 0px 5px;
                            border: 1px solid rgb(19, 47, 76);
                            background-color: #06101a;
                            color: white;
                        " class="input-group-text" id="basic-addon1">Name</span>
                    </div>
                    <input style="
                        border: 1px solid rgb(19, 47, 76);
                        background-color: rgb(5, 29, 54);
                        color: white;
                    " value="{{command.trigger}}" name="_trigger" id="_trigger" type="text" class="form-control"
                        placeholder="Username" aria-label="Username" aria-describedby="basic-addon1">
                </div>
                <div class="control-area">
                    <div class="title">
                        <span>Script</span>
                    </div>
                    <div class="area">
                        <div class="counter" id="counter">
                        </div>
                        <textarea contenteditable="true" class="form-control" name="_script" id="_script"
                            placeholder="Your script!">{{command.script}}</textarea>
                    </div>
                </div>
                <div class="actions doppy-margin-top-15 doppy-display-flex-row">
                    <button type="button" onclick="window.location = '/manage/{{bot._id}}#commands'"
                        class="doppy-btn doppy-btn-cancel" type="submit">Cancel</button>
                    <button type="submit" class="doppy-margin-left-5 doppy-btn doppy-btn-primary"
                        type="submit">Save</button>
                </div>

            </form>
        </div>
    </div>

</body>

</html>

<script type="text/javascript">
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

    function insertAtCursor(el, text) {
        text = text || '';
        if (document.selection) {
            // IE
            el.focus();
            var sel = document.selection.createRange();
            sel.text = text;
        } else if (el.selectionStart || el.selectionStart === 0) {
            // Others
            var startPos = el.selectionStart;
            var endPos = el.selectionEnd;
            el.value = el.value.substring(0, startPos) +
                text +
                el.value.substring(endPos, el.value.length);
            el.selectionStart = startPos + text.length;
            el.selectionEnd = startPos + text.length;
        } else {
            el.value += text;
        }
    };
    document.querySelector("#_script").addEventListener("keydown", function (e) {
        var TABKEY = 9;
        if (e.keyCode == TABKEY) {
            insertAtCursor(this, "\t");
            if (e.preventDefault) {
                e.preventDefault();
            }
            return false;
        }
    }, false);

    let script = $('#_script');
    let counter = $('#counter');

    let lines = script.val().split('\n');
    let html = '';
    for (let i = 0; i < lines.length; i++) {
        ;
        html += `<span>${i + 1}</span>\n`;
    }
    counter.html(html);
    script.on('input', e => {
        let lines = script.val().split('\n');
        let html = '';
        for (let i = 0; i < lines.length; i++) {
            ;
            html += `<span>${i + 1}</span>\n`;
        }
        counter.html(html);
    });



    function cmdCall(e) {
        e.preventDefault();
        let form = e.target;
        $.post($(form).prop('action'), $(form).serialize(), function (data) {
            if (data.success) {
                window.location.reload();
            } else {
                $('#error').toast('show');
                $('#error .toast-body').html(data.error);
            }
        });
    }

</script>